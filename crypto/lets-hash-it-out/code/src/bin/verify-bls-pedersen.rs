use std::fs::File;
use std::str::FromStr;
use std::time::{SystemTime, UNIX_EPOCH};

use ark_bls12_381::{Fr, G1Projective};
use ark_ec::AffineCurve;
use ark_ff::Zero;
use ark_serialize::Write;
use bls_pedersen::{bls::verify, hash::hash_to_curve};
use bls_pedersen::data::puzzle_data;
use bls_pedersen::PUZZLE_DESCRIPTION;
use prompt::{puzzle, welcome};
use ark_crypto_primitives::crh::pedersen::bytes_to_bits;

fn bytes_to_bits_string(bytes: &[u8]) -> String {
    let bits = bytes_to_bits(bytes);
    let mut s = String::with_capacity(bits.len());
    s.push('[');
    for bit in bits {
        if bit {
            s.push('1');
        } else {
            s.push('0');
        }
        s.push(',');
    }
    s.push(']');
    return s;
}
fn write_msgs_to_file(msgs: Vec<Vec<u8>>) {
    let mut file = File::create(format!(
        "bits_vecs-{}",
        (SystemTime::now().duration_since(UNIX_EPOCH))
            .unwrap()
            .as_millis()
    ))
    .unwrap();
    for msg in msgs {
        let blake = hash_to_curve(&msg).0;
        let string = bytes_to_bits_string(&blake);
        file.write_all(string.as_ref()).unwrap();
        file.write_all(b",").unwrap();
    }
}

fn main() {
    welcome();
    puzzle(PUZZLE_DESCRIPTION);
    let (pk, ms, sigs) = puzzle_data();
    // for (m, sig) in ms.iter().zip(sigs.iter()) {
    //     verify(pk, m, *sig);
    // }

    /* Your solution here! */
    let m = "Xor0v0";
    let (b2hash, _) = hash_to_curve(m.as_bytes());
    let bits = bytes_to_bits(&b2hash);
    let bits: Vec<u8> = bits.into_iter().map(|b| b as u8).collect(); // type convert
    println!("y = {:?}", &bits);
    
    // write_msgs_to_file(ms);
    // verify(pk, m_bytes, sig);

    let mut bad_sig = G1Projective::zero();
    let coefs = ["20284227033425027763233277958977844789245805636043480635714394335011252408171", "40373372484032675089701272023472705371805303840181868663339104404091607781329", "20999620817661158104091615115384131286241496732129392405000521390537312494971", "39795697778844093563312417531484776405760123063203633110591175393760864205743", "5796726736068928490460553308900032813546998071383145546045627381895577223970", "46941903732077663432094701053746398472093222319947855682023217104677608549649", "38264845256711204850532729513804414161731671225541275179262594295384214931081", "13019669266149144342339306274977879063578408689675138507240598648278210198921", "9337381890774839500624119557906858050271180596049074104784000305006764464280", "16143802584309919286442705063479484557030812624292717184974162454339619845391", "25606065321629895508765834279099804143267761150118694162340049988018712266835", "32783887872087749278780649035235265828837351921277145439112660681125437597070", "16974306486526226404357264477817425017297285366616719811859314385921485399206", "52327921559159566590643456583989889516288248827523118501462014549973207035778", "37541638235743182618616398420708065955438823218579366998152442460376508812464", "11474074383900215553933737913221433300250521097661040648747990134475314919693", "34359706713178885086622445802165237891685174666284003920195455333956173042849", "6604964800080109891298142972785988050730773960444854323167008897644759594520", "41634881563485416648193609770716099859035186363157463840953684424513627176696", "20554077909142192583186288614612495868737559053657501599034757799886114673384", "31508642704700529979101278699543304164099833299577959714482387362385765188394", "40387937020556128280907488428063337978990521350003372804324022772913171361570", "14786338811374675250201809889891346747975526932204635062235385965379260387164", "8086238592249960634419758785613149576497889720065968591477961110832486663906", "51489561657237277634380241627894886489231374905420587667311127728072728739186", "25013066051382287784531703576729197102768125410141181718369204231730568997494", "15131759304089424123212592376209735353806776194488914892054596983770177035960", "24473429661662809884488059552743571982776837880985650597626134803511154561070", "33846726468570527672197914990369791548360419313568625513344630456516694203464", "18551934804395319927860474644697569387775792860643707743993246278027841498213", "23392043927695181034946248138117759364036505392877029239537967599103485511672", "7448306968061352861096121825704665453933019291135773919881630303403916164282", "16912868199327279787420775298961990050224603771763577188559185752010544183036", "32907790606027608882287569023602436214645216951636737572039661743947650530640", "1317814882270103406258320538061501572354992682028571684710789096129200511881", "35846540714259131132618008091465459787940431157557694099135734245215100981912", "26069077632231974340782016479744567371925056124600373282337767554626050938925", "15573593417962319727748215315673012364693386809881894927841437948653635603718", "6093656502197375983956600249882173710383376859526999935189830125093374529915", "5599521260018207178835509433357028022417201628678917130393853349085879238927", "31549503825449541885165122327083820800700379231226223139293193213110314129797", "18881998572623994501546588819239831488588224783110522755416608944609356903795", "21725020143555882601077728025987383020689318767245694330224413528525742115155", "14562697261715254258456729682527163698171332056309804170053419911212614597694", "44043114691767529617239164783850270410741264974385974078060500640935889922700", "25128586010659152679778918616549872359469287302199917115258472635006106396442", "31651757688154845796294209915754179249906089232716227686749921405013050425077", "19479934519067088073835221156136759416743056533242647423342524801501809276993", "18713885557883966137963072974773171776424944884208028098695884961793120833606", "22783281442581344805581705868591274554850552955212205487900954501917311812418", "41831721804188129110730579153963411080200513271307711993887958161408273985289", "35040567800252551352978856357316694055826301442773974347714042241488680115331", "17866861000302327629341084197245804456099774890170911662763195845334871011171", "46722769174561030822753041430009576549882413932679485306373320724295603716582", "21442514438503133455943928736930901691133169906721717565690715202407592171920", "1591302804795849099399739221001098639485106364889525652723871140492209327872", "36648170303717592613550647975983306082566375751058655664583474913356696034931", "15766918124751487037074841180917369294056334262986276637294893949929015891809", "32230393216037507772574454125471433692830349690705047029922188952331598813027", "9244509798946576821733165072458522431903249142020542308540227428233317147922", "2419671685985351263678057546719444988419033485418035295054176075481478016088", "51955297396707090767241876795376139691811315386617912429152463877296256362685", "16760461582435118626469621999013575649439954563285612529367617029897200140856", "6717596896616120845562008292957307555363343321972680554384192222412623260483", "28789164656531442749897052056967129295896626276675661889468306786557248774093", "42378524592448106296419923465172648215843946032555329164596335370804031273360", "13772399551122091726454548083574705513777094442453978162993482887894760913310", "11408654874373447542218341998705828145216166499211887732212707141883771420259", "36567229050593054839920284614833851493695727496757394152575882488006825316205", "41780913551074972428283351929293438313430063657911817440477456062149511695501", "19707793141763638567507115522829168929928382778926370941296691211475909336140", "7413097247831010323955799607853907481972784249130152385794416250591797225433", "17251200204597418161146825207241207361286557974448216599893570027568517001956", "27951347505464810271641785522978661795446626885547687145184252241304667198258", "39204493466094764101746787127979423379317681857219931080840345355826666050524", "41934011842389575446212376493966558489817802484158033888946701669981037028702", "36342980752142502072162288883969670947417378653983679320644418708984941210529", "17447586176182891295911227811208399239335140574868910423601775442784286601691", "45225525758997578146991767836557819236648378334339672252283803944036112048442", "11607347381391395425654284781673072761123475067261037325855682652823737366107", "16779809086920201603458740245434633750693980588199714589256459805965326431379", "33985608765061289534020698818183249522406536155821306114189731825099685777192", "7626049251315817249142179362384816794353744621928859968468316836800555795647", "15685010446546823800949514129882647194973845873769788615138864259210826698159", "4535227090927459764886150251951597619239944278371717863743965993237702227822", "2161218615824640883796782119762572959954204060523925837616101243354551466847", "10575226287713556339243810084847079296855110584279514048194881421686710633725", "33601827998678055487633336168883413400474233671599963201245450529249856774725", "49465649695693849511514927656063449912768498010344888255901610929908614165398", "16482170638255764264796927206961355350819453698821986343252571853682319168456", "12293702899802380604419223419549777059771427171603146838750935023918887653228", "32437681428194088828854526185253016075924234502733413769781031858577703243495", "35391748339386177319168683731967349441876467074536123041379654470719378296040", "20404413325727464090201611957950148801991119692096162610097142734034187946959", "18165914871986601321839663857201569047650298936096446804651261317144718037906", "42542936422509725336133228726349575889236874975844661196225710866354192061609", "39580265437316664979056743937473994658134053974379207135118310092718021092906", "42847823573368648554904022394486105263249510158468875152455645971709239074468", "16626106911075380581723201216034081637378513047068527062698442605164497384788", "43930020509462430668835671966580006158625269953984457758850157695585621649442", "4305763895719997209323983704850735303917366292472841942703857205478562267618", "44112771955354085467100054867747208749777703250355712467864676930787723416266", "32588671014846735536477797283585856568930497053869384603223248555197238765818", "37164096680488890539556445380003892421580330889893135792392487412878450083568", "5673658441278110462359387778746956482335904902566523109340667820986670175424", "18528978567515669589495022908583545480514014959001984761635820164129640295484", "36343090825932136137958258357568118874044820247604701853634038242634174058652", "2420227818771451350893109939990402036827672762104417855350270683094902548620", "16201770453316408169664977300149756983819857272890000274610483674247830529260", "19704646902765748540783394843910674105603230085784807824308681978812326903357", "31818680304812091586206551083390758934331420707822804851493179733855732437656", "30308523475157296951738595366161120333408425072740731794792206703929310127352", "47240089647491201685867374799489431196321727882900343048828278148533012621315", "8698537053378994802396031602468273894627294066133806378039166064955760866457", "51179856442386929679624771678156489670502827050324080186729659793035496563304", "52002574297770221402956347268416570181924242401581597668765874143846572765055", "29358782010948218466886892854084030086066845145770421458205100201804120127010", "37042079203262268768415969535067321989120620048597240829563873850408908518892", "4069203245898008016665797640922689301425239795773758286222879682186872003994", "50939895734859826379578377947257471376213121778269531329701707376949361374022", "41407930067951163824524698161343063469463364572509161523312588584296450219552", "281205127944099617689775969643993188652202974214626504177186202929392530984", "2815365152141269700002468046792610484639340997785127465306834309531669057376", "50021833749493182459218319863863212206599871662886781626595982571033626872976", "43679653430131241611780038983035907289918129583040088980117228022763533852390", "26512805732436966078632546478738082181896378645283226129930246916561568627079", "41426200695587281363775364675065122174816308993141777746384054229943874997714", "50882767156667128630551175906222089029900516094423178429343142261547896354266", "15811665992705785692551796961260853418959888682258716308031181680780593362286", "21689594109880789839203261697220079646091630472847571929337198146723106366713", "11272054067653112305275659167623927324280708830423625700028417208871629286715", "39634266776806133008167846663009860998871967866394650469337570255706970872279", "17722908579910060811297412262006519900876297076748171040785090495653424348777", "30248677223633610409293855523803128567761882151710754277988608203537575889938", "342406676502738087163386909813422113050055688522560764931888334579550739693", "39141165794176929870671885886074723470350605774480868275594050248184112213657", "48914070332106351020842724385869675337832948122997055605110776526705259902748", "18143243421848903432856638586306682457937001286377451075289031546385457376131", "1595789111596461805566384284641123521144759904656000198399374803733690314002", "17415472589335103649330940684425100077278782352033188313843406462237252587852", "51960230821656660203693939487354944307649743865638221558837691908126763120455", "38434109509391531186297392231294846117503813614913925479551290362715539616645", "45226176683581334163513575716108912437396978576413748009521979516869274738096", "51981823210035455755529372492506950204399185856686155833925839021781064079041", "30117745188676945131907698836334507310962682506239387090047422239353706749010", "35976358887052255019978341359482849500000921721161885078693316853553869677417", "40822294365735308020145102496654542865094834214979866591306598115454272494360", "18752815443701675159800346116734738358627539626023794534852976774040826109965", "31250808743281467854144417370763023881985217809603688739706277349642594322649", "31062458816144110034669689876503844782494563367241455793755294747220588189266", "35279835477372147299465649821682189844197430573613818645594705461418802297432", "44128569117845384973433527946627958942040989508158320958379181518013559854696", "13393827862870791156511788924749138232949543911683926985998141374181156595026", "19319597280500295838310288592566361368031215312387090758797763788997448157472", "24236309784529198905597668226180969688638744500697593178831278045270057632861", "3247543840514018988615627023434281725067957631823351245335600160029797579245", "34326673359230552784586961473558805307216321761994616049771558490096571236987", "41519072976569873368938515065580655831172503777895014582303195603179644217825", "3092500466688867932167472060603859298460215685073342352239970896867226116070", "12334086998371016368580916282440076049578964930158045782082853434848854520529", "18092996964064431548314901922817585029510141909011147163930844314401595229940", "33893114780864732520550026273140091777557405584956889808058155986008395594885", "25795857166094007872187590317136427145616365320346405047987337166023218565528", "28489160304653250307977902479186914648039969315484797711891921642330545793398", "50805184145993566200584747143800247426196976713356624512874185640632707046237", "29172306721472551051296027639463365901107672317510933770056838738627521859565", "41914285250107261205949740142264750104604477338114999968709391164856914547945", "15246452066512350984939119666418135895421199166002982521845924863847245662382", "1839495465688211726077697912731106858907875192954662176159382717602058897167", "26426261819644886795015793889019745129497291642573226865882191116774533805182", "12846550061842718794488302905005512790265052077445221322134857470090285811039", "11675215391474848952781848810176330737158264085759252259288104479109258666841", "11192988494349538680093627368533453305004852999716725401596798679343755076195", "15247217831106517340302216107057897837155540251859063088580569617758602281478", "9944878723763288446984254771294804077425696407218007677382969947100459736902", "38012708503601742556156872210705176965646249500433943274393509071837169450295", "37768347473612676636595164340222408058771655972077788173551210877290235120711", "38654247069178183454304789744958149757495932383569373762979082089222880170183", "37268533403918162878949717746607349368078812219237827043277008370226130816506", "6209796729088226389733395834315969030222912164199498676139781369433826597905", "44703972226959934878692872173093038529731869694269111454276615112619117831430", "51798511379806009954590861932944057922584895146435566471187241847842110853280", "3354715885357303454050738975222042551150451183751450799624345720403461149979", "3687400338834713491652576186557799540570092394621060494169388559494360134408", "8493167908384859180460480440914736306799819287269179102247318373103481076746", "18369850754001225208369144182659018871214311238568479121098875199731908511954", "15576411871289308125538465883635802394564522337211256219619010063203421104757", "8777936757119083854651597819241656343002482189451221894424872659618063646622", "45876846661425078073717712566569759980633023046285769834438874380445245323560", "2630312010553129455766363181442058382486013599925214424107121215931203035326", "24437257262750577578706355073553477135901730482997318514597831668016599006385", "41868716828567896394606309374273780344742647085984719931236751769877353840258", "21947213640201061855908841595107857965209301210273840143119727232448070545786", "23015315899231881020465013165793020087705236006161447802994545387443394512756", "41277034233424328145802787410491485460520057427617020703163329614090531624990", "18900183296464685662821180053899459917012334372336525353518910705239575721684", "16779560008068236100651808530226896736211373999875417053842733415643910316563", "25860235182900593571143431086003704751899664531397844732848869793110535893722", "11443469955251670439225037820768515130168878665688014125235990216358788302720", "48341700370083246969176345180110193399371521887583461046063810993547870067290", "6845206873845871058105435479448950483931299869929442404919598492853079922838", "7210953819228648526652473555674018587451026852252313899443772990770476968431", "50145565526842154273374379663288555592760013633835432093788635973182895104419", "32256335626484621084720950109681872926730847092526048263402926281573992107882", "34497660669402501847721900190481505977123832238150946606919262847377522215445", "42906796035664727758754022153181252123012875673456420208650983073236640072776", "39035914165042930836420182631797702694897115202840934931923099311284429567911", "38463421582189033835746463873764863578101474308445616608522053071124823308141", "7882347209081652462837567613150330358316321245409300253901183080338792494542", "40238789162210509240338321636917358665656443634293455504688385702408063301151", "18792101289805213388917568560945486706475915911570872511838140859054262201253", "29888936846466623008154354626654331938313450611112845482220138071660825719845", "2294854013753410736397531471352423982868737276468356434554148490153066941059", "35412542367583230113060054847081216218684065342714168108372343780111651771420", "45706715368995242353289192920167512306014305907441562664462570857962089299255", "51153404346416208896459088946662589653512138557356691644969240784901946915841", "32078746170880343517603939060390486337853787813422627870018530041795467024048", "8142336868976197104568138174265305527675719878907524516525697120782143961308", "14809261148170634427377508018882866927675090965130218436540119225926672087998", "27309476398978070699831321615590071441803533651843061967972968559478655031723", "23315944253477676482701727904770517147964931943156386170587644001654445554470", "14315894023065843062443303672831734674526044517229170606213310159694151044157", "19678267285385502993235983364965554745935349264421198183332238163548033261200", "49416875262518607300636812649521535745889866010415167998313565879752926054347", "24793804765942715401457828435152261987384619195189962473083037455433195291475", "48757214700473286151082910794980034114288719883198252997015777155620913065771", "23625015730986339890157331307221610330369623394670555602898513142294727911319", "49834283603445028557147013469224392146030336314694620409074302699663454932715", "9325123436257667437699550328954579676122133560200939781865754921833018438793", "22423478450713570026306595060209155532251576455220666573030177943211747827468", "43815200127849505551383129576726067066103130259759613960576911763376752084661", "20222848571050351142917467282603051545704043659953228592851998830993225165717", "13460248928745155253468419225447255577809796240312924633571372520309738089741", "25743286528123156489973129214229285926037726428701133591698045347437537565798", "15053622949214349162338684655324844540645249343739765232234425777758019324451", "39365154704482869420506008815042047357227040581349085915322647881842568026648", "41444859520742706548425362651101822964045096328556528090264096510997265840210", "43210313769330051547783470309695061075731706639377711933763883384809671219693", "26106401332087002989304070590345191715166134606661430982896208948098170664989", "44666988919637689216112388856190928511469317763070082859437270402734511062955", "22051646840009088951998032345296732581209744834265571373614728310754428022114", "14740743894720313561972805730889837369209844664677572154427721775280145685380", "49888599474336767018961967840501121549277908070043371526741647080631161900604", "2226428591092427188852297273609125697078037027246847643550392518497016303114", "40457365089919799675424603047068092657065398040089839525215044029661342444427", "47636432557547746134675321919618290785609013406774503800766126591253194174383", "25764426033484082584247659872193844597372551421553143639362878768860742569527", "30952280361789272379718585352021894402169608928074681097327470987684436422468", "23301921066864243609599634820072336449804567113234659617478061398123765131830", "50199846303729111186077032834132520112897642289070389344914371076060369211", "29076616411801817675495903457577928851144543958786020135798181819796919704130", "32749792342878155015696215526918338374559072705954117303807811474393946525128", "51857978415084411058560324300359168036457076359417923703500287849019885509454", "13016277418102391693529419944110516341331482502334457725009941497753099607393", "23088803725380660621874147049352075783590521801750272988072008111941077683043", "10404073213690113210920066878777272797034206423564428988467902512791074554853"];
    let coeffs: Vec<_> = coefs.into_iter().map(|&coef| Fr::from_str(coef).unwrap()).collect();
    for (coeff, sig) in coeffs.into_iter().zip(sigs) {
        bad_sig += sig.mul(coeff);
    }

    // the solution
    verify(pk, "Xor0v0".as_bytes(), bad_sig.into());
    println!("YES!");
}
